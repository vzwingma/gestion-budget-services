sudo: required
language: java
services:
  - docker
cache:
  directories:
    - $HOME/.m2
git:
  depth: false
# Notification SLACK
notifications:
  slack: terrier-zed:zBgR60L3Sf7vLgxKqVonmaMT

script:
  # Tag de snapshot. C'est un tag pour permettre le déploiement sur GitHUB.
  - if [[ $TRAVIS_BRANCH == "master" ]];
    then 
      echo "ReTag de snapshot"; 
    else 
      echo "Pas de reTag de snapshot"; 
    fi

# Déploiement des releaes sur tag : snapshot ou version 
before_deploy:
  - echo "Construction de l'image Docker gestion_budget_services"; 
  - VERSION_DOCKER = "";
  - if [[ $TRAVIS_BRANCH == v* ]]; 
    then 
        VERSION_DOCKER_TAG=$(echo $TRAVIS_BRANCH | cut -b 2-); 
        VERSION_DOCKER="latest";
    else 
       VERSION_DOCKER="snapshot";
    fi;

after_deploy:
  # Deploiement sur MassiveGrid
  - ENV = "";
  - NODE_ID = 26374;
  - if [[ $TRAVIS_BRANCH == v* ]]; 
    then 
      ENV = "budget"
    else
      ENV = "budget-rec"
    fi;
  # Démarrage 
  - echo "Démarrage de l'environnement $ENV"
  - URL_START = $MASSIVEGRID_URL + "startenv?envName=" + $ENV + "&session=" + $MASSIVEGRID_USER_TOKEN
  - curl $URL_START  
  # Redéploiement   
  - echo "Redéploiement de la version " + $VERSION_DOCKER + " sur MassiveGrid " + $ENV;
  - URL_REDEPLOY = $MASSIVEGRID_URL + "redeploycontainers?envName=" + $ENV + "&session=" + $MASSIVEGRID_USER_TOKEN + "&tag=" + $VERSION_DOCKER +"&nodeId=" + $NODE_ID
  - curl -X POST $URL_REDEPLOY  
  # Arrêt   
  - echo "Arrêt de l'environnement $ENV"
  - URL_STOP = $MASSIVEGRID_URL + "stopenv?envName=" + $ENV + "&session=" + $MASSIVEGRID_USER_TOKEN
  - curl $URL_STOP
		 